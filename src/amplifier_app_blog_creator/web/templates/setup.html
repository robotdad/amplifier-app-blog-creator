{% extends "base.html" %}

{% block title %}Setup - Blog Creator{% endblock %}

{% block content %}
<div class="setup-container">
    <h1>Create Your Blog Post</h1>
    <p class="subtitle">Provide your writing samples and initial idea to get started.</p>

    <form id="setup-form" hx-post="/sessions/{{ session_id }}/start-workflow" hx-target="body">
        <!-- Idea File Input -->
        <div class="input-group">
            <label for="idea_path" class="input-label">
                <span class="label-text">Brain Dump File</span>
                <span class="label-hint">Markdown or text file with your initial thoughts</span>
            </label>
            <div class="path-input">
                <div class="path-input-row">
                    <input
                        type="text"
                        id="idea_path"
                        name="idea_path"
                        class="input-field"
                        placeholder="~/Documents/blog-idea.md"
                        required
                        hx-post="/sessions/{{ session_id }}/validate-path"
                        hx-trigger="blur, keyup changed delay:500ms"
                        hx-target="#idea-feedback"
                        hx-vals='{"type": "file"}'
                    >
                    <button type="button" class="button button-secondary" onclick="browseFile('idea_path')">
                        Browse
                    </button>
                </div>
                <div id="idea-feedback" class="feedback-container"></div>
            </div>
        </div>

        <!-- Writings Directory Input -->
        <div class="input-group">
            <label for="writings_dir" class="input-label">
                <span class="label-text">Writing Samples Directory</span>
                <span class="label-hint">Folder containing your previous blog posts (.md files)</span>
            </label>
            <div class="path-input">
                <div class="path-input-row">
                    <input
                        type="text"
                        id="writings_dir"
                        name="writings_dir"
                        class="input-field"
                        placeholder="~/Documents/blog-posts"
                        required
                        hx-post="/sessions/{{ session_id }}/validate-path"
                        hx-trigger="blur, keyup changed delay:500ms"
                        hx-target="#writings-feedback"
                        hx-vals='{"type": "directory"}'
                    >
                    <button type="button" class="button button-secondary" onclick="browseDirectory('writings_dir')">
                        Browse
                    </button>
                </div>
                <div id="writings-feedback" class="feedback-container"></div>
            </div>
        </div>

        <!-- Optional Instructions -->
        <div class="input-group">
            <label for="instructions" class="input-label">
                <span class="label-text">Additional Instructions (Optional)</span>
                <span class="label-hint">Any specific guidance for the AI</span>
            </label>
            <textarea
                id="instructions"
                name="instructions"
                class="textarea-field"
                rows="4"
                placeholder="e.g., 'Focus on technical details' or 'Keep it conversational'"
            ></textarea>
        </div>

        <!-- Actions -->
        <div class="form-actions">
            <button type="submit" class="button button-primary" id="start-btn" disabled>
                Start Creation
            </button>
        </div>
    </form>
</div>

<script>
// Enable start button only when both paths are valid
let ideaValid = false;
let writingsValid = false;

function updateStartButton() {
    const startBtn = document.getElementById('start-btn');
    startBtn.disabled = !(ideaValid && writingsValid);
}

// Listen for HTMX events to track validation state
document.body.addEventListener('htmx:afterSwap', function(event) {
    const target = event.detail.target.id;

    if (target === 'idea-feedback') {
        const feedback = event.detail.target.querySelector('.feedback-valid');
        ideaValid = !!feedback;
        updateStartButton();
    }

    if (target === 'writings-feedback') {
        const feedback = event.detail.target.querySelector('.feedback-valid');
        writingsValid = !!feedback;
        updateStartButton();
    }
});

// File browsing functionality
function browseFile(inputId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.md,.txt';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const pathInput = document.getElementById(inputId);
            pathInput.value = file.path || file.name;
            // Trigger validation
            htmx.trigger(pathInput, 'blur');
        }
    };
    input.click();
}

function browseDirectory(inputId) {
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;
    input.onchange = (e) => {
        const files = e.target.files;
        if (files.length > 0) {
            const pathInput = document.getElementById(inputId);
            // Get directory path from first file
            const firstFile = files[0];
            if (firstFile.webkitRelativePath) {
                const parts = firstFile.webkitRelativePath.split('/');
                parts.pop(); // Remove filename
                pathInput.value = parts.join('/');
            } else {
                pathInput.value = firstFile.path || '';
            }
            // Trigger validation
            htmx.trigger(pathInput, 'blur');
        }
    };
    input.click();
}
</script>
{% endblock %}
